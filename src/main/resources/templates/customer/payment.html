<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Payment - Tummy Go!</title>
	<link rel="stylesheet" th:href="@{/css/bootstrap.css}">
	<link rel="stylesheet" th:href="@{/css/font-awesome.min.css}">
	<style>
		:root {
			--primary-color: #fc8019;
			--primary-dark: #e66a00;
			--text-dark: #333;
			--bg-light: #fffaf3;
			--card-bg: #fff;
		}

		body.cafe-mode {
			--primary-color: #d28b4b;
			--primary-dark: #8b4513;
			--text-dark: #f5e6d3;
			--bg-light: #3e2723;
			--card-bg: rgba(79, 55, 45, 0.7);
			background: linear-gradient(180deg, #2c1810 0%, #3e2723 50%, #5d4037 100%) fixed;
			color: var(--text-dark);
		}

		body {
			background-color: var(--bg-light);
			color: var(--text-dark);
		}

		.navbar-custom {
			background-color: var(--primary-color);
			padding: 15px 0;
		}
		.navbar-custom .navbar-brand,
		.navbar-custom .nav-link {
			color: white;
			font-weight: 500;
		}
		.payment-card {
			border: 1px solid #e0e0e0;
			border-radius: 8px;
			padding: 20px;
			background: #fff;
			box-shadow: 0 4px 12px rgba(0,0,0,0.05);
		}
		.payment-option {
			border: 1px solid #ececec;
			border-radius: 6px;
			padding: 12px 16px;
			margin-bottom: 10px;
			cursor: pointer;
			transition: border-color 0.2s, box-shadow 0.2s;
			display: flex;
			align-items: center;
		}
		.payment-option input {
			margin-right: 10px;
		}
		.payment-option:hover {
			border-color: #fc8019;
			box-shadow: 0 2px 8px rgba(252,128,25,0.2);
		}
		.payment-option.active {
			border-color: #fc8019;
			box-shadow: 0 2px 8px rgba(252,128,25,0.25);
		}
		.payment-details {
			border-top: 1px solid #f2f2f2;
			margin-top: 1rem;
			padding-top: 1rem;
		}
		.summary-row {
			display: flex;
			justify-content: space-between;
			margin-bottom: 8px;
		}
		.badge-restaurant {
			background-color: #ffe8d6;
			color: #fc8019;
			font-weight: 500;
		}

		body.cafe-mode .payment-card {
			background: var(--card-bg) !important;
			border: 1px solid rgba(255, 255, 255, 0.15);
		}

		body.cafe-mode .payment-option {
			background: rgba(79, 55, 45, 0.5);
			border-color: rgba(255, 255, 255, 0.15);
		}
	</style>
</head>
<body th:classappend="${siteMode == T(com.srFoodDelivery.model.SiteMode).CAFE} ? 'cafe-mode' : ''">
<nav class="navbar navbar-expand-lg navbar-custom">
	<div class="container">
		<a class="navbar-brand" th:href="@{/customer/restaurants}">Tummy Go!</a>
		<div class="ml-auto d-flex align-items-center">
			<a class="nav-link" th:href="@{/customer/cart}">
				<i class="fa fa-shopping-cart"></i>
				Cart
				<span class="badge badge-light ml-1" th:text="${cartItemCount}">0</span>
			</a>
			<a sec:authorize="isAuthenticated()" class="nav-link" th:href="@{/logout}">Logout</a>
		</div>
	</div>
</nav>

<div class="container py-4">
	<div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
	<div th:if="${infoMessage}" class="alert alert-info" th:text="${infoMessage}"></div>

	<div class="d-flex justify-content-between align-items-center mb-3">
		<h3>Complete your payment</h3>
		<a class="btn btn-outline-secondary" th:href="@{/customer/cart}"><i class="fa fa-arrow-left"></i> Back to Cart</a>
	</div>

	<div class="row">
		<div class="col-lg-7 mb-4">
			<div class="payment-card">
				<h5 class="mb-3">Select a payment method</h5>
				<form method="post" th:action="@{/customer/payment/confirm}" id="payment-form">
					<input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

					<label class="payment-option"
					       th:classappend="${paymentSession.selectedPaymentOption == 'UPI'} ? ' active' : ''">
						<input type="radio" name="paymentOption" value="UPI"
						       th:checked="${paymentSession.selectedPaymentOption == 'UPI'}">
						<span><strong>UPI</strong> (GPay / PhonePe / Paytm)</span>
					</label>

					<label class="payment-option"
					       th:classappend="${paymentSession.selectedPaymentOption == 'CARD'} ? ' active' : ''">
						<input type="radio" name="paymentOption" value="CARD"
						       th:checked="${paymentSession.selectedPaymentOption == 'CARD'}">
						<span><strong>Credit / Debit Card</strong></span>
					</label>

					<label class="payment-option"
					       th:classappend="${paymentSession.selectedPaymentOption == 'COD'} ? ' active' : ''">
						<input type="radio" name="paymentOption" value="COD"
						       th:checked="${paymentSession.selectedPaymentOption == 'COD'}">
						<span><strong>Cash on Delivery</strong></span>
					</label>

					<div class="payment-details" id="upi-details"
					     th:classappend="${paymentSession.selectedPaymentOption != 'UPI'} ? ' d-none' : ''">
						<div class="form-group">
							<label class="font-weight-semibold" for="upiId">UPI ID</label>
							<input type="text" class="form-control" id="upiId" name="upiId" placeholder="name@bank"
							       th:value="${paymentSession.upiId}">
							<small class="form-text text-muted">Example: username@bank</small>
						</div>
					</div>

					<div class="payment-details" id="card-details"
					     th:classappend="${paymentSession.selectedPaymentOption != 'CARD'} ? ' d-none' : ''">
						<div class="form-group">
							<label class="font-weight-semibold" for="cardHolderName">Card holder name</label>
							<input type="text" class="form-control" id="cardHolderName" name="cardHolderName"
							       placeholder="Name on card" th:value="${paymentSession.cardHolderName}">
						</div>
						<div class="form-group">
							<label class="font-weight-semibold" for="cardNumber">Card number</label>
							<input type="text" class="form-control" id="cardNumber" name="cardNumber"
							       inputmode="numeric" pattern="[0-9]{16}" maxlength="16"
							       placeholder="16 digit number" th:value="${paymentSession.cardNumber}">
							<small class="form-text text-muted">Enter digits only, no spaces.</small>
						</div>
						<div class="form-row">
							<div class="form-group col-md-6">
								<label class="font-weight-semibold" for="cardExpiry">Expiry (MM/YY)</label>
								<input type="text" class="form-control" id="cardExpiry" name="cardExpiry"
								       placeholder="MM/YY" pattern="(0[1-9]|1[0-2])/[0-9]{2}" maxlength="5"
								       th:value="${paymentSession.cardExpiry}">
							</div>
							<div class="form-group col-md-6">
								<label class="font-weight-semibold" for="cardCvv">CVV</label>
								<input type="password" class="form-control" id="cardCvv" name="cardCvv"
								       inputmode="numeric" pattern="[0-9]{3,4}" maxlength="4" placeholder="3 or 4 digits">
							</div>
						</div>
					</div>

					<div class="payment-details" id="cod-details"
					     th:classappend="${paymentSession.selectedPaymentOption != 'COD'} ? ' d-none' : ''">
						<p class="mb-0 text-muted">You can pay the delivery partner in cash when your order arrives.</p>
					</div>

					<div class="mt-4 d-flex justify-content-between">
						<button type="submit" class="btn btn-primary">Pay &amp; Place Order</button>
					</div>
				</form>

				<form class="mt-3" method="post" th:action="@{/customer/payment/cancel}">
					<input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
					<button type="submit" class="btn btn-link text-danger p-0">Cancel payment</button>
				</form>
			</div>
		</div>

		<div class="col-lg-5">
			<div class="payment-card">
				<h5 class="mb-3">Order Summary</h5>
				<div class="mb-2" th:if="${cart.restaurant != null}">
					<span class="badge badge-pill badge-restaurant">From: <span th:text="${cart.restaurant.name}">Restaurant</span></span>
				</div>

				<div class="summary-row" th:each="item : ${items}">
					<div>
						<strong th:text="${item.menuItem != null ? item.menuItem.name : 'Item'}">Item</strong>
						<div class="text-muted" th:text="'Qty: ' + ${item.quantity}">Qty</div>
					</div>
					<div th:text="'₹' + ${#numbers.formatDecimal(item.lineTotal,1,2)}">₹0.00</div>
				</div>

				<hr>
				<div class="summary-row">
					<span><strong>Total</strong></span>
					<span th:text="'₹' + ${#numbers.formatDecimal(cart.totalAmount,1,2)}">₹0.00</span>
				</div>

				<hr>
				<h6>Delivery Address</h6>
				<p class="mb-2" th:text="${paymentSession.deliveryAddress}">123 Street</p>

				<div th:if="${paymentSession.specialInstructions}">
					<h6>Instructions</h6>
					<p class="mb-0" th:text="${paymentSession.specialInstructions}">Leave at door</p>
				</div>
			</div>
		</div>
</div>

<script th:src="@{/js/jquery-3.4.1.min.js}"></script>
<script th:src="@{/js/bootstrap.js}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const optionInputs = Array.from(document.querySelectorAll('input[name="paymentOption"]'));
        const detailSections = {
            UPI: document.getElementById('upi-details'),
            CARD: document.getElementById('card-details'),
            COD: document.getElementById('cod-details')
        };
        const optionLabels = Array.from(document.querySelectorAll('.payment-option'));

        function updateVisibility(selected) {
            Object.entries(detailSections).forEach(([key, section]) => {
                if (section) {
                    section.classList.toggle('d-none', key !== selected);
                }
            });
            optionLabels.forEach(label => {
                const input = label.querySelector('input[name="paymentOption"]');
                label.classList.toggle('active', input && input.value === selected);
            });
        }

        optionInputs.forEach(input => {
            input.addEventListener('change', function (event) {
                updateVisibility(event.target.value);
            });
        });

        const initialSelection = (optionInputs.find(input => input.checked) || optionInputs[0])?.value || 'UPI';
        updateVisibility(initialSelection);

        const cardNumberInput = document.getElementById('cardNumber');
        if (cardNumberInput) {
            cardNumberInput.addEventListener('input', function () {
                this.value = this.value.replace(/\D/g, '').slice(0, 16);
            });
        }

        const cardCvvInput = document.getElementById('cardCvv');
        if (cardCvvInput) {
            cardCvvInput.addEventListener('input', function () {
                this.value = this.value.replace(/\D/g, '').slice(0, 4);
            });
        }
    });
</script>
</body>
</html>