<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title th:text="${restaurant.name} + ' - Preorder'">Preorder</title>
	<link rel="stylesheet" th:href="@{/css/bootstrap.css}">
	<link rel="stylesheet" th:href="@{/css/font-awesome.min.css}">
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
		rel="stylesheet">
	<style>
		:root {
			--primary: #fc8019;
			--primary-dark: #e66a00;
			--accent: #48DBFB;
			--text-main: #2d3436;
			--text-light: #636e72;
			--bg-gradient: linear-gradient(135deg, #fffaf3 0%, #fff5eb 100%);
			--glass-bg: rgba(255, 255, 255, 0.90);
			--glass-border: rgba(252, 128, 25, 0.1);
			--shadow-soft: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
			--radius-lg: 24px;
			--radius-md: 16px;
			--anim-fast: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Poppins', sans-serif;
			background: var(--bg-gradient);
			color: var(--text-main);
			min-height: 100vh;
			line-height: 1.6;
		}

		/* Cafe Mode Overrides */
		body.cafe-mode {
			--primary: #D35400;
			--primary-dark: #A04000;
			--text-main: #FDFEFE;
			--text-light: #E5E7E9;
			--bg-gradient: linear-gradient(180deg, #1A120B 0%, #3E2723 100%);
			--glass-bg: rgba(62, 39, 35, 0.9);
			--glass-border: rgba(255, 255, 255, 0.1);
		}

		/* Navbar Styling */
		.navbar-custom {
			background: rgba(255, 255, 255, 0.95);
			backdrop-filter: blur(10px);
			padding: 1rem 0;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
			z-index: 1000;
		}

		body.cafe-mode .navbar-custom {
			background: rgba(26, 18, 11, 0.95);
			border-bottom: 1px solid rgba(255, 255, 255, 0.1);
		}

		.navbar-custom .navbar-brand {
			color: var(--primary);
			font-weight: 800;
			font-size: 1.8rem;
			letter-spacing: -0.5px;
		}

		.navbar-custom .nav-link {
			color: var(--text-main);
			font-weight: 600;
			padding: 10px 20px;
			border-radius: 50px;
			transition: all 0.3s ease;
		}

		.navbar-custom .nav-link:hover {
			background: var(--primary);
			color: white;
			transform: translateY(-2px);
		}

		/* Global Components */
		.container {
			max-width: 1200px;
		}

		/* Header */
		.restaurant-header {
			background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
			color: white;
			padding: 40px;
			border-radius: var(--radius-lg);
			box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
			margin-bottom: 40px;
			position: relative;
			overflow: hidden;
		}

		.restaurant-header::after {
			content: '';
			position: absolute;
			top: -50%;
			right: -10%;
			width: 300px;
			height: 300px;
			background: rgba(255, 255, 255, 0.1);
			border-radius: 50%;
		}

		.restaurant-name {
			font-size: 2.5rem;
			font-weight: 800;
			margin-bottom: 15px;
		}

		.info-banner {
			background: rgba(255, 255, 255, 0.15);
			backdrop-filter: blur(5px);
			padding: 15px 25px;
			border-radius: var(--radius-md);
			display: inline-block;
		}

		.info-banner i,
		.info-banner strong {
			color: white;
		}

		/* Step Indicator */
		.step-indicator {
			display: flex;
			justify-content: space-between;
			position: relative;
			margin-bottom: 50px;
			padding: 0 20px;
		}

		.step-indicator::before {
			content: '';
			position: absolute;
			top: 25px;
			left: 40px;
			right: 40px;
			height: 4px;
			background: #e0e0e0;
			z-index: 0;
			border-radius: 10px;
		}

		.step {
			position: relative;
			z-index: 1;
			text-align: center;
			cursor: default;
			width: 120px;
		}

		.step-number {
			width: 50px;
			height: 50px;
			background: white;
			border: 4px solid #e0e0e0;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 700;
			font-size: 1.2rem;
			color: #b2bec3;
			margin: 0 auto 10px;
			transition: all 0.4s ease;
		}

		.step.active .step-number {
			border-color: var(--primary);
			color: var(--primary);
			background: white;
			box-shadow: 0 0 0 4px rgba(255, 107, 107, 0.2);
			transform: scale(1.1);
		}

		.step.completed .step-number {
			background: var(--primary);
			border-color: var(--primary);
			color: white;
		}

		.step-title {
			font-weight: 600;
			color: #b2bec3;
			font-size: 0.9rem;
			transition: color 0.3s ease;
		}

		.step.active .step-title,
		.step.completed .step-title {
			color: var(--text-main);
		}

		/* Step Content with Glassmorphism */
		.step-content {
			display: none;
			background: var(--glass-bg);
			backdrop-filter: blur(12px);
			-webkit-backdrop-filter: blur(12px);
			border: 1px solid var(--glass-border);
			border-radius: var(--radius-lg);
			box-shadow: var(--shadow-soft);
			padding: 40px;
			margin-bottom: 30px;
			animation: fadeIn 0.5s ease;
		}

		.step-content.active {
			display: block;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(20px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		/* Forms & Typography */
		.section-title {
			font-size: 1.8rem;
			font-weight: 700;
			margin-bottom: 30px;
			color: var(--text-main);
			display: flex;
			align-items: center;
			gap: 15px;
		}

		.section-title i {
			color: var(--primary);
		}

		.form-control {
			background: #f8f9fa;
			border: 2px solid transparent;
			padding: 15px 20px;
			border-radius: var(--radius-md);
			font-size: 1rem;
			color: var(--text-main);
			transition: all 0.3s ease;
			height: auto;
		}

		.form-control:focus {
			background: white;
			border-color: var(--primary);
			box-shadow: 0 0 0 4px rgba(255, 107, 107, 0.1);
		}

		.date-time-selector {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
			gap: 30px;
			margin-bottom: 30px;
		}

		label {
			font-weight: 600;
			margin-bottom: 10px;
			color: var(--text-light);
			display: block;
		}

		/* Table Floor Plan */
		.floor-plan-container {
			background: #eef2f3;
			border-radius: var(--radius-lg);
			padding: 40px;
			box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
			min-height: 600px;
			overflow: auto;
		}

		.floor-plan {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
			gap: 40px;
			padding: 20px;
		}

		/* Advanced 3D Table styling */
		.table-item {
			position: relative;
			background: transparent;
			padding-top: 100%;
			/* Aspect Ratio Square-ish */
			width: 100%;
			height: 0;
			cursor: pointer;
			transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
			/* Clean up old borders */
			border: none;
			box-shadow: none;
		}

		.table-visual {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: white;
			border-radius: 50%;
			/* Default round table */
			box-shadow:
				0 15px 35px rgba(0, 0, 0, 0.1),
				0 5px 15px rgba(0, 0, 0, 0.05),
				inset 0 -5px 10px rgba(0, 0, 0, 0.05);
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			border: 4px solid white;
			transition: all 0.3s ease;
		}

		/* Square tables for 4+ capacity */
		.table-item[data-table-capacity="4"] .table-visual,
		.table-item[data-table-capacity="6"] .table-visual,
		.table-item[data-table-capacity="8"] .table-visual {
			border-radius: 30px;
		}

		/* Adjust widths of parent to control size in grid */
		/* Actually grid controls size, but we can set min/max size constraints on item */

		.table-number {
			font-size: 1.5rem;
			font-weight: 800;
			color: #2d3436;
			text-shadow: none;
			margin-bottom: 5px;
		}

		.table-capacity {
			font-size: 0.85rem;
			color: #636e72;
			font-weight: 600;
			background: #f1f2f6;
			padding: 4px 12px;
			border-radius: 20px;
			margin-top: 5px;
		}

		/* States */
		.table-item.available .table-visual {
			border-color: #2ecc71;
			background: #ffffff;
		}

		.table-item.selected .table-visual {
			background: linear-gradient(135deg, #fc8019 0%, #ff9f43 100%);
			transform: translateY(-10px) scale(1.05);
			box-shadow:
				0 20px 40px rgba(252, 128, 25, 0.4),
				0 10px 20px rgba(252, 128, 25, 0.2);
			border-color: #ffeaa7;
		}

		.table-item.selected .table-number,
		.table-item.selected .table-capacity {
			color: white;
		}

		.table-item.selected .table-capacity {
			background: rgba(255, 255, 255, 0.2);
		}

		.table-item.occupied .table-visual {
			background: #dfe6e9;
			border-color: #b2bec3;
			opacity: 0.6;
			box-shadow: none;
			transform: scale(0.95);
		}

		.table-item.occupied {
			pointer-events: none;
			cursor: not-allowed;
		}

		/* Menu Items */
		.menu-item-card {
			background: white;
			border-radius: var(--radius-md);
			padding: 20px;
			margin-bottom: 20px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
			display: flex;
			align-items: center;
			justify-content: space-between;
			transition: transform 0.3s ease;
			border: 1px solid rgba(0, 0, 0, 0.05);
		}

		.menu-item-card:hover {
			transform: translateY(-3px);
			box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
		}

		.quantity-btn {
			width: 36px;
			height: 36px;
			border-radius: 12px;
			border: none;
			background: #f1f2f6;
			color: var(--text-main);
			font-weight: 700;
			cursor: pointer;
			transition: all 0.2s ease;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.quantity-btn:hover:not([disabled]) {
			background: var(--primary);
			color: white;
		}

		.quantity-btn:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		/* Buttons */
		.btn-primary {
			background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
			color: white;
			border: none;
			padding: 15px 40px;
			border-radius: 50px;
			font-weight: 700;
			letter-spacing: 0.5px;
			text-transform: uppercase;
			font-size: 0.9rem;
			box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
			transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
		}

		.btn-primary:hover:not(:disabled) {
			transform: translateY(-4px);
			box-shadow: 0 15px 30px rgba(255, 107, 107, 0.4);
		}

		.btn-primary:disabled {
			background: #bdc3c7;
			box-shadow: none;
			cursor: not-allowed;
			opacity: 0.7;
		}

		.btn-outline-secondary {
			background: transparent;
			border: 2px solid #dfe6e9;
			color: var(--text-light);
			padding: 13px 30px;
			border-radius: 50px;
			font-weight: 600;
			transition: all 0.3s ease;
		}

		.btn-outline-secondary:hover {
			border-color: var(--text-main);
			color: var(--text-main);
			background: white;
		}

		/* Filter Buttons */
		.filter-btn {
			background: white;
			border: 2px solid transparent;
			padding: 10px 25px;
			border-radius: 50px;
			font-weight: 600;
			color: var(--text-light);
			box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
			transition: all 0.3s ease;
			margin-right: 10px;
			margin-bottom: 10px;
		}

		.filter-btn.active {
			background: var(--text-main);
			color: white;
			box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
		}

		.filter-btn:hover:not(.active) {
			transform: translateY(-2px);
			box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
		}

		.total-section {
			background: #f8f9fa;
			padding: 25px;
			border-radius: var(--radius-md);
			margin-top: 30px;
		}

		.total-row.final {
			font-size: 1.25rem;
			font-weight: 800;
			color: var(--primary);
			border-top: 1px dashed #ced6e0;
			padding-top: 15px;
			margin-top: 15px;
		}

		/* Offer Cards */
		.offer-card {
			background: white;
			border: 1px solid #eee;
			border-left: 4px solid var(--primary);
			border-radius: 12px;
			padding: 15px;
			width: 200px;
			cursor: pointer;
			transition: all 0.3s ease;
			position: relative;
			overflow: hidden;
		}

		.offer-card:hover {
			transform: translateY(-5px);
			box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
			border-color: var(--primary);
		}

		.offer-card.active-filter {
			background: #fff5eb;
			border-color: var(--primary);
			box-shadow: 0 0 0 2px var(--primary);
		}

		.offer-badge {
			font-weight: 800;
			color: var(--primary);
			font-size: 1.1rem;
			margin-bottom: 5px;
		}

		.offer-title {
			font-weight: 600;
			font-size: 0.9rem;
			color: var(--text-main);
			line-height: 1.3;
			margin-bottom: 5px;
		}

		.offer-code {
			background: #eee;
			padding: 2px 8px;
			border-radius: 4px;
			font-family: monospace;
			font-size: 0.85rem;
			display: inline-block;
			margin-bottom: 5px;
			border: 1px dashed #ccc;
		}

		.offer-desc {
			font-size: 0.8rem;
			line-height: 1.4;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}
	</style>
</head>

<body th:classappend="${siteMode != null and siteMode.name() == 'CAFE'} ? 'cafe-mode' : ''">
	<!-- Navigation -->
	<nav class="navbar navbar-expand-lg navbar-custom">
		<div class="container">
			<a class="navbar-brand" th:href="@{/customer/restaurants}">Tummy Go!</a>
			<div class="ml-auto d-flex align-items-center">
				<a class="nav-link d-flex align-items-center" th:href="@{/customer/cart}">
					<i class="fa fa-shopping-cart"></i>
					<span class="ml-1">Cart</span>
					<span class="badge badge-light ml-2" th:text="${cartItemCount}">0</span>
				</a>
				<span sec:authorize="isAuthenticated()" class="text-white mr-3">
					Welcome, <span sec:authentication="name"></span>
				</span>
				<a sec:authorize="isAuthenticated()" class="nav-link" th:href="@{/logout}">Logout</a>
			</div>
		</div>
	</nav>

	<div class="container py-4">
		<div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
		<div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

		<!-- Restaurant Header -->
		<div class="restaurant-header">
			<h2 class="restaurant-name" th:text="${restaurant.name}">Restaurant Name</h2>
			<div class="info-banner">
				<i class="fa fa-info-circle"></i>
				<strong>Preorder with Table Selection:</strong> Choose your date, time, table, and menu items. Your food
				will be ready when you arrive!
			</div>
		</div>

		<!-- Step Indicator -->
		<div class="step-indicator">
			<div class="step" id="step1" data-step="1">
				<div class="step-number">1</div>
				<div class="step-title">Date &amp; Time</div>
			</div>
			<div class="step" id="step2" data-step="2">
				<div class="step-number">2</div>
				<div class="step-title">Select Table</div>
			</div>
			<div class="step" id="step3" data-step="3">
				<div class="step-number">3</div>
				<div class="step-title">Menu Items</div>
			</div>
			<div class="step" id="step4" data-step="4">
				<div class="step-number">4</div>
				<div class="step-title">Payment</div>
			</div>
		</div>

		<!-- Step 1: Date & Time Selection -->
		<div class="step-content active" id="content-step1">
			<h3 class="section-title">
				<i class="fa fa-calendar"></i> Select Date &amp; Time
			</h3>
			<div class="date-time-selector">
				<div class="form-group">
					<label>Reservation Date</label>
					<input type="date" class="form-control" id="reservationDate" th:value="${selectedDate}" min=""
						required>
				</div>
				<div class="form-group">
					<label>Reservation Time</label>
					<input type="time" class="form-control" id="reservationTime" th:value="${selectedTime}" required>
				</div>
			</div>
			<div class="form-group">
				<label>Number of Guests</label>
				<select class="form-control" id="numberOfGuests" th:value="${numberOfGuests}">
					<option value="1">1 Guest</option>
					<option value="2" selected>2 Guests</option>
					<option value="3">3 Guests</option>
					<option value="4">4 Guests</option>
					<option value="5">5 Guests</option>
					<option value="6">6 Guests</option>
					<option value="7">7 Guests</option>
					<option value="8">8+ Guests</option>
				</select>
			</div>
			<div class="form-group">
				<label>Duration (hours)</label>
				<select class="form-control" id="durationHours">
					<option value="1" selected>1 Hour</option>
					<option value="2">2 Hours</option>
					<option value="3">3 Hours</option>
				</select>
			</div>
			<div class="navigation-buttons">
				<a th:href="@{|/customer/restaurants/${restaurant.id}|}" class="btn btn-outline-secondary">
					<i class="fa fa-arrow-left"></i> Back
				</a>
				<button type="button" class="btn btn-primary" onclick="goToStep(2)">
					Next: Select Table <i class="fa fa-arrow-right"></i>
				</button>
			</div>
		</div>

		<!-- Step 2: Table Selection -->
		<div class="step-content" id="content-step2">
			<h3 class="section-title">
				<i class="fa fa-table"></i> Select Table
			</h3>

			<!-- Table Type Filter -->
			<div class="table-filter-buttons" th:if="${tableTypes != null and !tableTypes.isEmpty()}">
				<button type="button" class="filter-btn active" data-filter="all"
					onclick="filterTables('all')">All</button>
				<button type="button" class="filter-btn" th:each="type : ${tableTypes}" th:data-filter="${type}"
					th:text="${#strings.replace(type, '_', ' ')}"
					th:attr="onclick='filterTables(this.getAttribute(\'data-filter\'))'">Type</button>
			</div>

			<!-- Section Filter -->
			<div class="table-filter-buttons" th:if="${sections != null and !sections.isEmpty()}">
				<button type="button" class="filter-btn active" data-section="all" onclick="filterBySection('all')">All
					Sections</button>
				<button type="button" class="filter-btn" th:each="section : ${sections}" th:data-section="${section}"
					th:text="${section}"
					th:attr="onclick='filterBySection(this.getAttribute(\'data-section\'))'">Section</button>
			</div>

			<!-- 3D Floor Plan -->
			<div class="floor-plan-container" id="floorPlanContainer">

				<div class="floor-plan" id="floorPlan">
					<!-- Tables -->
					<div th:if="${tables == null or tables.isEmpty()}" class="alert alert-warning"
						style="width: 100%; text-align: center; padding: 40px;">
						<i class="fa fa-exclamation-triangle"></i> No tables available for this restaurant.
					</div>

					<div th:each="table : ${tables}" th:if="${table != null}" class="table-item available"
						th:data-table-id="${table.id}" th:data-table-capacity="${table.capacity}"
						th:data-table-type="${table.tableType}" th:data-section="${table.sectionName}"
						th:attr="onclick='selectTable(parseInt(this.getAttribute(\'data-table-id\')), parseInt(this.getAttribute(\'data-table-capacity\')))'">
						<!-- Improved Table Visual Structure -->
						<div class="table-visual">
							<div class="table-number" th:text="${table.tableNumber}">1</div>
							<div class="table-capacity" th:text="'Seats: ' + ${table.capacity}">2</div>
						</div>
					</div>
				</div>
			</div>

			<div class="alert alert-info" id="selectedTableInfo" style="display: none;">
				<i class="fa fa-check-circle"></i>
				<strong>Selected:</strong> <span id="selectedTableNumber"></span>
				(<span id="selectedTableCapacity"></span> seats)
			</div>

			<div class="navigation-buttons">
				<button type="button" class="btn btn-outline-secondary" onclick="goToStep(1)">
					<i class="fa fa-arrow-left"></i> Previous
				</button>
				<button type="button" class="btn btn-primary" id="nextToMenuBtn" onclick="goToStep(3)" disabled>
					Next: Select Menu <i class="fa fa-arrow-right"></i>
				</button>
			</div>
		</div>

		<!-- Step 3: Menu Items Selection -->
		<div class="step-content" id="content-step3">
			<h3 class="section-title">
				<i class="fa fa-cutlery"></i> Select Menu Items
			</h3>
			<div th:if="${menuItems == null or menuItems.isEmpty()}" class="alert alert-info">
				<i class="fa fa-info-circle"></i> No menu items available for this restaurant.
			</div>

			<!-- Offers Section -->
			<div th:if="${!#lists.isEmpty(activeOffers)}" class="mb-4">
				<h5 class="mb-3"><i class="fa fa-percent text-primary mr-2"></i>Available Offers</h5>
				<div class="offer-cards-container d-flex flex-wrap" style="gap: 15px;">
					<div th:each="offer : ${activeOffers}" class="offer-card clickable-offer"
						th:data-offer-id="${offer.id}" th:data-offer-code="${offer.couponCode}"
						th:data-applicable-items="${offer.applicableMenuItemIds}" onclick="toggleOfferFilter(this)">
						<div class="offer-badge"
							th:text="${offer.offerType == 'PERCENTAGE_OFF' ? offer.discountValue + '% OFF' : '₹' + offer.discountValue + ' OFF'}">
							OFF</div>
						<div class="offer-title" th:text="${offer.title}">Title</div>
						<div class="offer-code" th:if="${offer.couponCode}" th:text="${offer.couponCode}">CODE</div>
						<div class="offer-desc small text-muted" th:text="${offer.description}">Desc</div>
					</div>
				</div>
				<button id="clearOfferFilterBtn" class="btn btn-sm btn-link text-muted mt-2 d-none"
					onclick="clearOfferFilter()">
					<i class="fa fa-times mr-1"></i>Clear Offer Filter
				</button>
			</div>

			<div th:each="item : ${menuItems}" th:if="${item != null}" class="menu-item-card"
				th:data-item-id="${item.id}" th:data-item-price="${item.price}">
				<div class="menu-item-info">
					<div class="menu-item-name" th:text="${item.name}">Item Name</div>
					<div class="menu-item-price" th:text="'₹' + ${#numbers.formatDecimal(item.price,1,2)}">₹0.00</div>
				</div>
				<div class="quantity-controls">
					<button type="button" class="quantity-btn"
						th:attr="onclick='decreaseQuantity(parseInt(this.closest(\'.menu-item-card\').getAttribute(\'data-item-id\')))'">
						<i class="fa fa-minus"></i>
					</button>
					<span class="quantity-display" th:id="'qty-' + ${item.id}">0</span>
					<button type="button" class="quantity-btn"
						th:attr="onclick='increaseQuantity(parseInt(this.closest(\'.menu-item-card\').getAttribute(\'data-item-id\')))'"
						th:disabled="${!item.available}">
						<i class="fa fa-plus"></i>
					</button>
				</div>
			</div>

			<!-- Total Section -->
			<div class="total-section">
				<div class="total-row">
					<span>Subtotal:</span>
					<span id="subtotal">₹0.00</span>
				</div>
				<div class="total-row final">
					<span>Total:</span>
					<span id="total">₹0.00</span>
				</div>
			</div>

			<div class="navigation-buttons">
				<button type="button" class="btn btn-outline-secondary" onclick="goToStep(2)">
					<i class="fa fa-arrow-left"></i> Previous
				</button>
				<button type="button" class="btn btn-primary" id="nextToPaymentBtn" onclick="goToStep(4)" disabled>
					Next: Payment <i class="fa fa-arrow-right"></i>
				</button>
			</div>
		</div>

		<!-- Step 4: Review and Proceed to Payment -->
		<div class="step-content" id="content-step4">
			<h3 class="section-title">
				<i class="fa fa-check-circle"></i> Review Your Preorder
			</h3>
			<div class="alert alert-info">
				<i class="fa fa-info-circle"></i> Please review your preorder details below. You will select your
				payment method on the next page.
			</div>

			<!-- Order Summary -->
			<div class="total-section mt-4">
				<h5 class="mb-3">Order Summary</h5>
				<div class="total-row">
					<span>Selected Table:</span>
					<span id="summaryTable">-</span>
				</div>
				<div class="total-row">
					<span>Date &amp; Time:</span>
					<span id="summaryDateTime">-</span>
				</div>
				<div class="total-row">
					<span>Guests:</span>
					<span id="summaryGuests">-</span>
				</div>
				<div class="total-row">
					<span>Items:</span>
					<span id="summaryItems">0</span>
				</div>

				<!-- Coupon Section -->
				<div class="coupon-section mt-3 mb-3 p-3"
					style="background: rgba(252, 128, 25, 0.05); border-radius: 10px;">
					<label style="font-size: 0.9em;">Have a Coupon?</label>
					<div class="d-flex">
						<input type="text" id="couponCode" class="form-control mr-2" placeholder="Enter code"
							style="height: 40px;">
						<button type="button" class="btn btn-sm btn-outline-secondary" onclick="applyCoupon()"
							style="border-radius: 10px; width: 80px; height: 40px; font-weight: 600;">Apply</button>
					</div>
					<div id="couponMessage" class="mt-2" style="font-size: 0.85em;"></div>
				</div>

				<div class="total-row" id="discountRow" style="display: none; color: #2ecc71;">
					<span>Discount:</span>
					<span id="summaryDiscount">-₹0.00</span>
				</div>

				<div class="total-row final">
					<span>Total:</span>
					<span id="summaryTotal">₹0.00</span>
				</div>
			</div>

			<div class="navigation-buttons">
				<button type="button" class="btn btn-outline-secondary" onclick="goToStep(3)">
					<i class="fa fa-arrow-left"></i> Previous
				</button>
				<button type="button" class="btn btn-primary" id="addToCartBtn" onclick="addToCart()" disabled>
					<i class="fa fa-shopping-cart"></i> Add to Cart &amp; Complete
				</button>
			</div>
		</div>
	</div>

	<script th:src="@{/js/jquery-3.4.1.min.js}"></script>
	<script th:src="@{/js/bootstrap.js}"></script>
	<script th:inline="javascript">
		/*<![CDATA[*/
		const restaurantId = /*[[${restaurant.id}]]*/ null;
		const csrfParameterName = /*[[${_csrf != null ? _csrf.parameterName : '_csrf'}]]*/ '_csrf';
		const csrfToken = /*[[${_csrf != null ? _csrf.token : ''}]]*/ '';
		/*]]>*/
	</script>
	<script>
		let currentStep = 1;
		let selectedTableId = null;
		let selectedTableNumber = null;
		let selectedTableCapacity = null;
		let selectedDate = '';
		let selectedTime = '';
		let numberOfGuests = 2;
		let durationHours = 1;
		let itemQuantities = {};
		let itemPrices = {};

		// New variables for reservation hold
		let currentReservationId = null;
		let pollingInterval = null;

		// Set minimum date to today
		document.addEventListener('DOMContentLoaded', function () {
			const today = new Date().toISOString().split('T')[0];
			document.getElementById('reservationDate').setAttribute('min', today);

			// Initialize item prices from data attributes
			document.querySelectorAll('.menu-item-card[data-item-id]').forEach(function (card) {
				const itemId = card.getAttribute('data-item-id');
				const itemPrice = parseFloat(card.getAttribute('data-item-price')) || 0;
				if (itemId) {
					itemPrices[itemId] = itemPrice;
				}
			});

			// Initialize from URL parameters
			const urlParams = new URLSearchParams(window.location.search);
			if (urlParams.get('date')) {
				selectedDate = urlParams.get('date');
				document.getElementById('reservationDate').value = selectedDate;
			}
			if (urlParams.get('time')) {
				selectedTime = urlParams.get('time');
				document.getElementById('reservationTime').value = selectedTime;
			}
			if (urlParams.get('guests')) {
				numberOfGuests = parseInt(urlParams.get('guests'));
				document.getElementById('numberOfGuests').value = numberOfGuests;
			}
		});

		// Coupon variables
		let appliedDiscount = 0;
		let appliedCouponCode = null;
		let appliedOfferId = null;

		function startPolling() {
			if (pollingInterval) clearInterval(pollingInterval);
			pollTableStatus(); // Immediate check
			pollingInterval = setInterval(pollTableStatus, 3000); // Poll every 3 seconds
		}

		function stopPolling() {
			if (pollingInterval) {
				clearInterval(pollingInterval);
				pollingInterval = null;
			}
		}

		function pollTableStatus() {
			// Only poll if we have date/time/restaurant
			if (!restaurantId || !selectedDate || !selectedTime) return;

			fetch(`/api/table-reservations/status?restaurantId=${restaurantId}&date=${selectedDate}&time=${selectedTime}`)
				.then(response => response.json())
				.then(data => {
					updateTableStatuses(data.statuses);
				})
				.catch(err => console.error('Error polling table status:', err));
		}

		function updateTableStatuses(statuses) {
			// statuses is map: { tableId: "AVAILABLE" | "HELD_BY_ME" | "HELD_BY_OTHERS" | "BOOKED" }
			if (!statuses) return;

			document.querySelectorAll('.table-item').forEach(item => {
				const tableId = parseInt(item.getAttribute('data-table-id'));
				const status = statuses[tableId] || "AVAILABLE";

				item.classList.remove('available', 'occupied', 'selected', 'held-by-others');

				// Re-add helper classes
				if (status === 'AVAILABLE') {
					item.classList.add('available');
					item.style.pointerEvents = 'auto';
					item.style.opacity = '1';
				} else if (status === 'HELD_BY_ME') {
					item.classList.add('selected');
					item.style.pointerEvents = 'auto'; // allow clicking to potentially unselect?
					// Ensure local state matches
					if (selectedTableId !== tableId) {
						// This implies we held it in backend but local JS lost sync? 
						// Or refreshed page? For now assume local state is master for "selection" logic
					}
				} else if (status === 'HELD_BY_OTHERS' || status === 'BOOKED') {
					item.classList.add('occupied');
					item.style.pointerEvents = 'none'; // Cannot select
				}
			});
		}

		function goToStep(step) {
			// Validate current step before proceeding
			if (currentStep === 1) {
				selectedDate = document.getElementById('reservationDate').value;
				selectedTime = document.getElementById('reservationTime').value;
				numberOfGuests = parseInt(document.getElementById('numberOfGuests').value);
				durationHours = parseInt(document.getElementById('durationHours').value);

				if (!selectedDate || !selectedTime) {
					alert('Please select both date and time');
					return;
				}

				// Determine if we are moving TO step 2 (Table Selection)
				if (step === 2) {
					startPolling();
				}
			}

			if (currentStep === 2) {
				if (step === 1) {
					// Going back: release hold if any
					if (selectedTableId) {
						releaseCurrentHold();
						selectedTableId = null;
						document.getElementById('selectedTableInfo').style.display = 'none';
						document.getElementById('nextToMenuBtn').disabled = true;
					}
					stopPolling();
				} else if (step === 3) {
					// Proceeding: Check if table selected
					if (!selectedTableId) {
						alert('Please select a table');
						return;
					}
					// Verify we still hold it (polling might update status async, but let's trust local hold success for now)
					stopPolling();
				}
			}

			if (currentStep === 3 && step === 2) {
				// Going back to table selection
				startPolling();
			}

			if (currentStep === 3 && step === 4) {
				const hasItems = Object.values(itemQuantities).some(qty => qty > 0);
				if (!hasItems) {
					alert('Please select at least one menu item');
					return;
				}
				updateOrderSummary();
			}

			// UI Updates for Step Navigation
			if (step === 3) updateNextToPaymentButton();

			document.getElementById('content-step' + currentStep).classList.remove('active');
			document.getElementById('step' + currentStep).classList.remove('active');

			if (step > currentStep) {
				document.getElementById('step' + currentStep).classList.add('completed');
			}

			currentStep = step;
			document.getElementById('content-step' + currentStep).classList.add('active');
			document.getElementById('step' + currentStep).classList.add('active');

			if (currentStep === 3) updateNextToPaymentButton();
		}

		function selectTable(tableId, capacity) {
			// If clicking the same table, do nothing (or we could unselect)
			if (selectedTableId === tableId) return;

			// If we already have a reservation/hold, release it first
			if (currentReservationId) {
				releaseCurrentHold().then(() => {
					performHold(tableId, capacity);
				});
			} else {
				performHold(tableId, capacity);
			}
		}

		function performHold(tableId, capacity) {
			// UI optimistic update (optional, but better wait for server)
			const tableElem = document.querySelector(`[data-table-id="${tableId}"]`);

			const formData = new FormData();
			formData.append('restaurantId', restaurantId);
			formData.append('tableId', tableId);
			formData.append('date', selectedDate);
			formData.append('time', selectedTime);
			formData.append('durationMinutes', durationHours * 60);

			fetch('/api/table-reservations/hold', {
				method: 'POST',
				headers: {
					[csrfParameterName]: csrfToken
				},
				body: formData
			})
				.then(response => {
					if (response.ok) return response.json();
					throw new Error('Table unavailable');
				})
				.then(data => {
					// Success
					currentReservationId = data.reservationId;
					selectedTableId = tableId;
					selectedTableCapacity = capacity;

					// Update UI
					updateTableStatuses(null); // Clear old styles logic if any, but better rely on manual update below or polling
					document.querySelectorAll('.table-item').forEach(item => {
						item.classList.remove('selected');
					});
					if (tableElem) tableElem.classList.add('selected');

					// Select info
					document.getElementById('selectedTableInfo').style.display = 'block';
					document.getElementById('selectedTableNumber').textContent = tableElem.querySelector('.table-number').textContent;
					document.getElementById('selectedTableCapacity').textContent = capacity;

					document.getElementById('nextToMenuBtn').disabled = false;

					// Force a poll update to ensure others are marked correctly
					pollTableStatus();
				})
				.catch(err => {
					alert('This table was just taken by someone else. Please select another.');
					pollTableStatus(); // Refresh view
				});
		}

		function releaseCurrentHold() {
			if (!currentReservationId) return Promise.resolve();

			return fetch(`/api/table-reservations/hold/${currentReservationId}`, {
				method: 'DELETE',
				headers: {
					[csrfParameterName]: csrfToken
				}
			})
				.then(() => {
					currentReservationId = null;
					// UI update handled by caller or polling
				})
				.catch(err => console.error('Error releasing hold:', err));
		}

		// Ensure hold is released if user leaves page (best effort)
		window.addEventListener('beforeunload', function (e) {
			if (currentReservationId && currentStep < 4) { // If not yet paid
				// Use sendBeacon for reliable async call on unload
				// Needs simpler API or carefully constructed request.
				// For now simplified fetch (might be cancelled)
				// Navigator.sendBeacon is better:
				const formData = new FormData();
				formData.append('_csrf', csrfToken);
				// Delete method not supported by beacon usually (only POST). 
				// So we rely on auto-expiry (15 mins) as backup.
			}
		});

		function filterTables(type) {
			document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => btn.classList.remove('active'));
			document.querySelector(`[data-filter="${type}"]`).classList.add('active');
			document.querySelectorAll('.table-item').forEach(item => {
				const itemType = item.getAttribute('data-table-type');
				item.style.display = (type === 'all' || itemType === type) ? 'block' : 'none';
			});
		}

		function filterBySection(section) {
			document.querySelectorAll('.filter-btn[data-section]').forEach(btn => btn.classList.remove('active'));
			document.querySelector(`[data-section="${section}"]`).classList.add('active');
			document.querySelectorAll('.table-item').forEach(item => {
				const itemSection = item.getAttribute('data-section');
				item.style.display = (section === 'all' || itemSection === section) ? 'block' : 'none';
			});
		}

		function increaseQuantity(itemId) {
			if (!itemQuantities[itemId]) itemQuantities[itemId] = 0;
			itemQuantities[itemId]++;
			updateQuantityDisplay(itemId);
			updateTotal();
			updateAddToCartButton();
			updateNextToPaymentButton();
		}

		function decreaseQuantity(itemId) {
			if (!itemQuantities[itemId] || itemQuantities[itemId] <= 0) return;
			itemQuantities[itemId]--;
			updateQuantityDisplay(itemId);
			updateTotal();
			updateAddToCartButton();
			updateNextToPaymentButton();
		}

		function updateQuantityDisplay(itemId) {
			const display = document.getElementById('qty-' + itemId);
			if (display) display.textContent = itemQuantities[itemId] || 0;
		}

		function updateTotal() {
			let subtotal = 0;
			for (let itemId in itemQuantities) {
				if (itemQuantities[itemId] > 0 && itemPrices[itemId]) {
					subtotal += itemPrices[itemId] * itemQuantities[itemId];
				}
			}
			document.getElementById('subtotal').textContent = '₹' + subtotal.toFixed(2);

			let finalTotal = subtotal - appliedDiscount;
			if (finalTotal < 0) finalTotal = 0;

			document.getElementById('total').textContent = '₹' + finalTotal.toFixed(2);
		}

		function updateOrderSummary() {
			const tableNum = document.getElementById('selectedTableNumber').textContent;
			document.getElementById('summaryTable').textContent = selectedTableNumber ? 'Table ' + selectedTableNumber : tableNum;
			document.getElementById('summaryDateTime').textContent = selectedDate && selectedTime ?
				new Date(selectedDate + 'T' + selectedTime).toLocaleString() : '-';
			document.getElementById('summaryGuests').textContent = numberOfGuests;

			const itemCount = Object.values(itemQuantities).reduce((sum, qty) => sum + (qty > 0 ? 1 : 0), 0);
			document.getElementById('summaryItems').textContent = itemCount;

			let total = 0;
			for (let itemId in itemQuantities) {
				if (itemQuantities[itemId] > 0 && itemPrices[itemId]) {
					total += itemPrices[itemId] * itemQuantities[itemId];
				}
			}

			let finalTotal = total - appliedDiscount;
			if (finalTotal < 0) finalTotal = 0;

			if (appliedDiscount > 0) {
				document.getElementById('discountRow').style.display = 'flex';
				document.getElementById('summaryDiscount').textContent = '-₹' + appliedDiscount.toFixed(2);
			} else {
				document.getElementById('discountRow').style.display = 'none';
			}

			document.getElementById('summaryTotal').textContent = '₹' + finalTotal.toFixed(2);
		}

		function applyCoupon() {
			const code = document.getElementById('couponCode').value.trim();
			if (!code) {
				alert("Please enter a coupon code");
				return;
			}

			let subtotal = 0;
			for (let itemId in itemQuantities) {
				if (itemQuantities[itemId] > 0 && itemPrices[itemId]) {
					subtotal += itemPrices[itemId] * itemQuantities[itemId];
				}
			}

			if (subtotal <= 0) {
				alert("Please add items to cart first");
				return;
			}

			const formData = new FormData();
			formData.append('code', code);
			formData.append('restaurantId', restaurantId);
			formData.append('orderAmount', subtotal);

			fetch('/api/coupons/validate', {
				method: 'POST',
				headers: {
					[csrfParameterName]: csrfToken
				},
				body: formData
			})
				.then(res => res.json())
				.then(data => {
					const msgDiv = document.getElementById('couponMessage');
					if (data.valid) {
						appliedDiscount = data.discountAmount;
						appliedCouponCode = data.code;
						appliedOfferId = data.offerId;

						msgDiv.textContent = data.message;
						msgDiv.style.color = 'green';

						updateTotal();
						updateOrderSummary();
					} else {
						msgDiv.textContent = data.message;
						msgDiv.style.color = 'red';
						appliedDiscount = 0;
						appliedCouponCode = null;
						appliedOfferId = null;
						updateTotal();
						updateOrderSummary();
					}
				})
				.catch(err => console.error(err));
		}

		// Offer Filtering Logic
		let activeOfferId = null;

		function toggleOfferFilter(cardElement) {
			const offerId = cardElement.getAttribute('data-offer-id');
			const offerCode = cardElement.getAttribute('data-offer-code');
			const applicableItemsStr = cardElement.getAttribute('data-applicable-items');

			// If clicking already active filter, clear it
			if (activeOfferId === offerId) {
				clearOfferFilter();
				return;
			}

			// Activate this filter
			activeOfferId = offerId;

			// Highlight card
			document.querySelectorAll('.offer-card').forEach(c => c.classList.remove('active-filter'));
			cardElement.classList.add('active-filter');

			// Show clear button
			const clearBtn = document.getElementById('clearOfferFilterBtn');
			if (clearBtn) clearBtn.classList.remove('d-none');

			// Filter menu items
			const allItems = document.querySelectorAll('.menu-item-card');

			if (!applicableItemsStr || applicableItemsStr === 'null' || applicableItemsStr.trim() === '') {
				// No specific restriction => show all? 
				// BUT user says "show items which have 50% discount".
				// If offer implies all items, we show all.
				allItems.forEach(item => item.style.display = 'flex');
			} else {
				// Filter specific items
				const allowedIds = applicableItemsStr.split(',').map(s => s.trim());
				allItems.forEach(item => {
					const itemId = item.getAttribute('data-item-id');
					if (allowedIds.includes(itemId)) {
						item.style.display = 'flex';
					} else {
						item.style.display = 'none';
					}
				});
			}

			// Interaction: Auto-fill coupon code if available
			// Only if they haven't applied one yet? 
			// Let's prompt or just fill it.
			if (offerCode && offerCode !== 'null') {
				// We don't have the coupon input visible in step 3 unless it's in header?
				// The coupon input is typically in the summary or payment step.
				// Store it for auto-apply later?
				// For now, let's just toast/alert or auto-set var if appropriate.
				// Actually, let's set it in the hidden inputs immediately if we want to "apply" it.
				// But applying coupon usually happens at checkout.
				// Let's simply copy to clipboard or just visual indication.
			}
		}

		function clearOfferFilter() {
			activeOfferId = null;
			document.querySelectorAll('.offer-card').forEach(c => c.classList.remove('active-filter'));
			document.getElementById('clearOfferFilterBtn').classList.add('d-none');

			// Show all items
			document.querySelectorAll('.menu-item-card').forEach(item => item.style.display = 'flex');
		}

		function updateAddToCartButton() {
			const hasItems = Object.values(itemQuantities).some(qty => qty > 0);
			const btn = document.getElementById('addToCartBtn');
			if (hasItems && selectedTableId && selectedDate && selectedTime) btn.disabled = false;
			else btn.disabled = true;
		}

		function updateNextToPaymentButton() {
			const hasItems = Object.values(itemQuantities).some(qty => qty > 0);
			document.getElementById('nextToPaymentBtn').disabled = !hasItems;
		}

		function addToCart() {
			if (!selectedTableId) {
				alert('Please select a table');
				return;
			}
			if (!selectedDate || !selectedTime) {
				alert('Please select date and time');
				return;
			}
			const items = [];
			for (let itemId in itemQuantities) {
				if (itemQuantities[itemId] > 0) {
					items.push({
						menuItemId: parseInt(itemId),
						quantity: parseInt(itemQuantities[itemId])
					});
				}
			}

			if (items.length === 0) {
				alert('Please select at least one item');
				return;
			}

			const form = document.createElement('form');
			form.method = 'POST';
			form.action = '/customer/preorder/add-to-cart';
			form.enctype = 'application/x-www-form-urlencoded';

			// CSRF
			const csrfInput = document.createElement('input');
			csrfInput.type = 'hidden';
			csrfInput.name = csrfParameterName;
			csrfInput.value = csrfToken;
			form.appendChild(csrfInput);

			// Coupon
			if (appliedCouponCode && appliedOfferId) {
				const couponCodeInput = document.createElement('input');
				couponCodeInput.type = 'hidden';
				couponCodeInput.name = 'couponCode';
				couponCodeInput.value = appliedCouponCode;
				form.appendChild(couponCodeInput);

				const offerIdInput = document.createElement('input');
				offerIdInput.type = 'hidden';
				offerIdInput.name = 'offerId';
				offerIdInput.value = appliedOfferId;
				form.appendChild(offerIdInput);
			}

			// Standard fields
			const inputs = {
				'restaurantId': restaurantId,
				'tableId': selectedTableId,
				'reservationDate': selectedDate,
				'reservationTime': selectedTime,
				'durationMinutes': durationHours * 60,
				'numberOfGuests': numberOfGuests,
				'paymentMethod': 'ONLINE'
			};

			// Add reservation ID if we have one (from Hold)
			if (currentReservationId) {
				inputs['reservationId'] = currentReservationId;
			}

			for (const [name, value] of Object.entries(inputs)) {
				const input = document.createElement('input');
				input.type = 'hidden';
				input.name = name;
				input.value = value;
				form.appendChild(input);
			}

			// Add items
			items.forEach((item) => {
				const idIn = document.createElement('input');
				idIn.type = 'hidden';
				idIn.name = 'itemIds';
				idIn.value = item.menuItemId;
				form.appendChild(idIn);

				const qtyIn = document.createElement('input');
				qtyIn.type = 'hidden';
				qtyIn.name = 'quantities';
				qtyIn.value = item.quantity;
				form.appendChild(qtyIn);
			});

			document.body.appendChild(form);
			form.submit();
		}
	</script>
</body>

</html>